Exceptions are unscheduled events that disrupt the normal flow of execution (interupts or faults)

![[Pasted image 20251111205623.png]]
*A list of several common exceptions*

The classification Axes are:
Synchronous vs Asynchronous: synchronous exceptions are ones that occurs at the same place every time the program is executed with the same input data and memory allocation. Asynchronous exceptions are usually caused by devices external to the CPU. 

User Requested vs Coerced: User requested exceptions are directly asked for by the user; these include breakpoints or traps to the OS. Synchronous exceptions are coerced, because they are the results of some hardware event uncontrollable to the user. 

User Maskable vs unmaskable: User can enable / disable exception type

Within vs between instructions: between exceptions are recognized between instructions, which allows the previous instruction to finish. within instructions are caused by the instruction itself rather than an external factor. 

Resume vs Terminate: Terminate stops a program's execution, and resume determines if still runs. 

There are very few exceptions that can be handled by just terminating execution. Most cases involve stopping execution, handling the exception, and then resuming, which IG is complex. 

# Exception Handling

The most difficult case for handling exceptions in a pipelined processor is one where the exception occurs within an instruction, and the instruction needs to be restartable. For example, page faults do not occur until the MEM stage of the pipeline. 

To handle exceptions: 
1. Force a trap into the pipeline on the next IF
2. Turn off all writes for the instruciton with the exception, as well as for all instructions that follow that instruction, until the trap is processed. 
3. Exception handling routine in the OS immediately saves the PC of the faulting instruction
4. Special instructions return the processor from the exception by reloading the PC to restart the instruction stream. 
5. Precise exceptions: machine can be stoped so that instructions before the instruction with the exception are completed and those after it can be restarted from scratch. 

# Exceptions in RISC V
There are various exceptions that can occur on different stages of the RISC V pipeline. 

| **Pipeline Stage** | **Problem exceptions occurring**                                                       |
| ------------------ | -------------------------------------------------------------------------------------- |
| IF                 | Page fault on instruction fetch; misaligned memory access; memory protection violation |
| ID                 | undefined or illegal opcode                                                            |
| EX                 | arithmetic exception                                                                   |
| MEM                | Page fault on data fetch; misalgined memory access; memory protection violation        |
| WB                 | None                                                                                   |
## Issues caused by multiple exceptions
Multiple exceptions can occur within the same clock cycle; the ID might cause a page fault in the MEM stage, and the add instruction might have an integer overflow in the same clock. 

This case is complicated, because exceptions can occur out of order, because instructions may cause the exception before an earlier exception causes one. this is a problem if the processor supports [[10. Precise Exceptions]], which means that all instructions before the faulting instruction are ran; 